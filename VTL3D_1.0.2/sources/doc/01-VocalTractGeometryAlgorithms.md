# VocalTract 类几何算法分析：中线与横截面计算

本文档深入分析 `VocalTract` 类（主要基于 `VocalTract.cpp`）中用于从三维声道模型计算声道中线和横截面积函数的关键算法和流程。这些计算是将复杂的3D几何映射到声学模型所需简化表示的核心步骤。

## 概述

计算流程通常遵循以下顺序：

1.  **三维表面生成 (`VocalTract::calcSurfaces`)**: 此为前提步骤。根据当前的声道控制参数（如舌位、颌开度等）和内部存储的解剖学定义，动态生成构成声道各个部分（硬腭、软腭、舌头、咽壁、嘴唇等）的3D表面。这些表面由 `Surface` 对象表示，内部是顶点和三角形网格。同时，此步骤也会生成关键的2D矢状面轮廓线（如 `upperOutline`, `lowerOutline`, `tongueOutline`），它们是 `LineStrip2D` 对象。

2.  **声道中线计算 (`VocalTract::calcCenterLine`)**: 根据上述2D矢状面轮廓线，计算出一条贯穿声道的近似三维中线。

3.  **横截面轮廓提取 (`VocalTract::getCrossProfiles`)**: 沿着计算出的中线，在多个离散位置（或根据特定规则选取的位置）定义切割平面（通常垂直于中线），并计算这些平面与声道3D表面的交线，从而得到每个位置的2D横截面轮廓。

4.  **横截面属性计算 (`VocalTract::getCrossSection`)**: 根据提取出的2D横截面轮廓，计算其面积和周长。

5.  **(可选) 管序列转换 (`VocalTract::crossSectionsToTubeSections`)**: 将沿中线分布的连续横截面属性离散化为一系列长度和面积恒定的管段，供某些声学模型（如传输线模型 `TlModel` 或时域模型 `TdsModel`）使用。

## 详细算法步骤

### 1. 声道中线计算 (`VocalTract::calcCenterLine`)

此函数的目标是根据矢状面上的主要轮廓线（上壁、下壁/舌、舌面）找到一条平滑的声道中心路径。

*   **初始路径估计 (μ-line)**:
    *   首先定义一条称为 "μ-line" 的参数化初始路径。这条路径并非几何中心，而是根据关键解剖点（如舌头中心、声道前后界）和声道的宏观形态（如舌体部分的圆弧形状）来大致勾勒。
    *   μ-line 被分为几段（例如，咽腔段、舌体段、口腔前段），并计算其总长度。

*   **沿μ-line采样并投影到实际轮廓**:
    *   沿μ-line等距采样一系列点。
    *   在每个采样点，确定一个局部"法线"方向（通常垂直于μ-line在该点的切线，或基于局部解剖结构）。
    *   从采样点沿此法线方向（及其反方向）发射射线，计算与 `upperOutline`、`lowerOutline`、`tongueOutline`（以及可能的 `epiglottisOutline`）的交点。
    *   通过这些交点确定在该法线方向上声道的实际上下边界。这两个边界点的中点被视为一个"粗糙中线点"（`roughCenterLine` 或 `nuLine`）。

*   **中线平滑**:
    *   上一步得到的"粗糙中线点"序列可能不平滑。采用移动平均或类似平滑算法（例如，使用一个固定长度的窗口，对窗口内的粗糙中线点进行加权平均）处理这些点，生成最终的 `centerLine` 点序列。

*   **端点和法线调整**:
    *   对中线的声门端和唇端点的位置和法线方向进行特殊调整，确保它们与声道的实际生理开口对齐。
    *   重新计算并平滑化整个 `centerLine` 上各点的法向量。法向量通常通过其相邻中线点定义的线段旋转90度得到，并进行归一化。

*   **法线交叉修正 (`verifyCenterLineNormal`, `correctPointPosition`)**:
    *   这是一个迭代过程，用于确保相邻中线点的法向量（代表后续横截面的方向）不会发生不合理的交叉或突变。如果检测到交叉，会调整法线方向或中线点的位置。
    *   此步骤对生成连续且无自相交的横截面至关重要。

*   **记录中线点属性**:
    *   对于最终的每个 `centerLine[i]` 点，记录其在整个中线上的累积路径长度 (`centerLine[i].pos`)。
    *   重新计算并存储从该中线点沿其法线到声道上下边界的距离 (`centerLine[i].min`, `centerLine[i].max`)。

### 2. 横截面轮廓提取 (`VocalTract::getCrossProfiles`)

此函数对于每个中线点 `centerLine[i]`（包含位置 `P` 和法线 `v`），提取出垂直于中线的二维横截面轮廓。

*   **切割平面定义**: 由中线点 `P` 和法线 `v` 定义一个切割平面。
*   **轮廓采样线**: 在此切割平面内，通常会沿着一个或多个方向（例如，平行于矢状面Z轴的方向，或者垂直于矢状面Z轴的方向）定义采样线。
*   **与3D表面相交测试**:
    *   沿着这些采样线进行等距采样。对于每个采样点，或者更准确地说，是代表切割线上的一系列平行射线，测试其与声道所有相关3D表面（`surface[UPPER_COVER]`, `surface[TONGUE]`, 等）的交点。
    *   **利用 `Surface` 类的方法**: 调用 `Surface::prepareIntersection`（利用瓦片加速结构）和 `Surface::getTriangleIntersection`（或 `getTriangleList`）来高效地找到所有与当前切割平面相交的三角形，并计算精确交点。
*   **构建上下轮廓 (`upperProfile`, `lowerProfile`)**:
    *   对于切割线（或平面）上的每个采样位置（通常是沿横向Z轴的坐标），收集所有上方表面的最低交点（Y值）作为该Z坐标处的上轮廓点 `upperProfile[z_idx]`。
    *   类似地，收集所有下方表面的最高交点（Y值）作为下轮廓点 `lowerProfile[z_idx]`。
    *   `upperProfileSurface` 和 `lowerProfileSurface` 数组记录构成轮廓的每个点分别来自哪个具体的3D表面。
*   **轮廓后处理**:
    *   对初始提取的上下轮廓点进行处理，例如：
        *   填充因采样稀疏或几何复杂性导致的间隙（通常使用线性插值）。
        *   确保下轮廓点始终位于上轮廓点之下。
        *   处理特殊情况，如嘴唇完全闭合或牙齿接触，此时上下轮廓可能重合或非常接近。
*   **确定主导发音器官 (`articulator`)**:
    *   根据在横截面中心区域（近矢状面处）构成下轮廓的主要3D表面（例如，是舌头、下唇还是下牙槽），来标记该横截面的主导发音器官。

### 3. 横截面属性计算 (`VocalTract::getCrossSection`)

*   **输入**: 由 `getCrossProfiles` 生成的 `upperProfile` 和 `lowerProfile` 数组。
*   **面积计算**:
    *   将上下轮廓之间的区域离散为一系列小的梯形（或矩形）。
    *   通过数值积分方法（如梯形法则，即 `0.5 * (height1 + height2) * width`）累加这些小梯形的面积，得到总的横截面积。
*   **周长计算**:
    *   分别计算上轮廓线和下轮廓线的长度（通过累加相邻轮廓采样点之间的直线段长度）。
    *   两段轮廓线长度之和近似为横截面的湿周（不包括左右两侧的虚拟封闭边界）。

## 算法依赖与关键技术

*   **`Surface` 类**: 核心的3D表面表示和操作单元，提供了高效的相交测试算法（基于瓦片空间划分）。
*   **`Splines.h` (各种样条类)**: 用于定义和插值构成声道解剖结构和轮廓的平滑曲线（如贝塞尔曲线、线性分段条带）。
*   **几何计算**: 大量的向量运算、点线面关系判断、交点计算、距离计算、参数化曲线求值等。
*   **启发式规则与经验参数**: 在中线平滑、法线调整、轮廓后处理以及主导发音器官判断等环节，应用了许多基于对声道解剖和声学特性理解的启发式方法和预设参数，以保证结果的鲁棒性和合理性。

## 对CSV导入方案的启示

如果CSV文件能直接提供以下两种信息之一：
1.  **中线点 + 每个中线点的横截面上下轮廓点 (`upperProfile`, `lowerProfile`)**：那么上述步骤2、3可以被跳过，直接进入步骤4计算面积周长，或进入步骤5生成管序列。
2.  **中线点 + 每个中线点的横截面积和周长**: 那么步骤2、3、4都可以被跳过，直接进入步骤5（如果需要管序列的话）。

`Acoustic3dSimulation` 若能直接使用CSV提供的中线和横截面数据（可能是详细轮廓或已计算的面积/周长），则 `VocalTract` 类中实现上述复杂几何计算的大部分代码（参数化驱动的表面生成、中线提取、横截面相交测试等）对该特定流程而言将是冗余的。

届时，`VocalTract` 类可以被大幅简化，主要职责可能变为：
*   作为从CSV加载这些预处理几何数据的容器。
*   提供 `Acoustic3dSimulation` 可能仍然需要的、非几何的、全局性参数或配置。 